\doxysection{Referencia del archivo C\+:/\+Users/\+Matias D/\+Documents/\+Proyecto\+\_\+\+Final/fw/app/mcu/src/sys/sys\+\_\+sm.c}
\hypertarget{fw_2app_2mcu_2src_2sys_2sys__sm_8c}{}\label{fw_2app_2mcu_2src_2sys_2sys__sm_8c}\index{C:/Users/Matias D/Documents/Proyecto\_Final/fw/app/mcu/src/sys/sys\_sm.c@{C:/Users/Matias D/Documents/Proyecto\_Final/fw/app/mcu/src/sys/sys\_sm.c}}


Máquina de estados principal del sistema.  


{\ttfamily \#include "{}sys\+\_\+sm.\+h"{}}\newline
{\ttfamily \#include "{}Free\+RTOS.\+h"{}}\newline
{\ttfamily \#include "{}cmsis\+\_\+os.\+h"{}}\newline
{\ttfamily \#include "{}dev\+\_\+\+LCD.\+h"{}}\newline
{\ttfamily \#include "{}mpu6050.\+h"{}}\newline
{\ttfamily \#include "{}ds3231.\+h"{}}\newline
{\ttfamily \#include "{}mpu\+\_\+math.\+h"{}}\newline
{\ttfamily \#include "{}dev\+\_\+gpio\+\_\+cfg.\+h"{}}\newline
{\ttfamily \#include "{}dev\+\_\+uart.\+h"{}}\newline
{\ttfamily \#include $<$math.\+h$>$}\newline
{\ttfamily \#include $<$stdio.\+h$>$}\newline
{\ttfamily \#include $<$string.\+h$>$}\newline
{\ttfamily \#include $<$stdbool.\+h$>$}\newline
\doxysubsubsection*{Estructuras de datos}
\begin{DoxyCompactItemize}
\item 
struct \mbox{\hyperlink{struct_s_m___handler}{SM\+\_\+\+Handler}}
\begin{DoxyCompactList}\small\item\em Estructura de control que contiene todas las variables de la SM principal. \end{DoxyCompactList}\item 
struct \mbox{\hyperlink{struct_boot___status}{Boot\+\_\+\+Status}}
\begin{DoxyCompactList}\small\item\em Estructura utilizada en el proceso de inicialización de dispositivos. \end{DoxyCompactList}\end{DoxyCompactItemize}
\doxysubsubsection*{defines}
\begin{DoxyCompactItemize}
\item 
\#define \mbox{\hyperlink{fw_2app_2mcu_2src_2sys_2sys__sm_8c_afde0a91566f74d38cdffe80c6635576d}{SAMPLE\+\_\+\+PERIOD\+\_\+\+MS}}~100
\begin{DoxyCompactList}\small\item\em Configuración del ciclo de muestreo y actualización del sistema. \end{DoxyCompactList}\item 
\Hypertarget{fw_2app_2mcu_2src_2sys_2sys__sm_8c_a3a79a5381592691da8312e12b08c3762}\label{fw_2app_2mcu_2src_2sys_2sys__sm_8c_a3a79a5381592691da8312e12b08c3762} 
\#define {\bfseries PERIOD\+\_\+100\+MS}~pd\+MS\+\_\+\+TO\+\_\+\+TICKS(100)
\item 
\Hypertarget{fw_2app_2mcu_2src_2sys_2sys__sm_8c_a0ed53db670d38530f814bae8a27d8f66}\label{fw_2app_2mcu_2src_2sys_2sys__sm_8c_a0ed53db670d38530f814bae8a27d8f66} 
\#define {\bfseries PERIOD\+\_\+1S}~pd\+MS\+\_\+\+TO\+\_\+\+TICKS(1000)
\item 
\Hypertarget{fw_2app_2mcu_2src_2sys_2sys__sm_8c_a5f44877bb23fb397a658ecd081cb5712}\label{fw_2app_2mcu_2src_2sys_2sys__sm_8c_a5f44877bb23fb397a658ecd081cb5712} 
\#define {\bfseries UART\+\_\+\+REFRESH\+\_\+\+DIV}~5
\item 
\Hypertarget{fw_2app_2mcu_2src_2sys_2sys__sm_8c_af5abd28c44c29b7397c84f1fec4b1d84}\label{fw_2app_2mcu_2src_2sys_2sys__sm_8c_af5abd28c44c29b7397c84f1fec4b1d84} 
\#define {\bfseries ALPHA}~0.\+2f                /\texorpdfstring{$\ast$}{*} Filtro utilizado para el calculo del angulo\texorpdfstring{$\ast$}{*}/
\item 
\Hypertarget{fw_2app_2mcu_2src_2sys_2sys__sm_8c_a9e8aaf9c28f704136d8fc1ba043b6bf5}\label{fw_2app_2mcu_2src_2sys_2sys__sm_8c_a9e8aaf9c28f704136d8fc1ba043b6bf5} 
\#define {\bfseries STR\+\_\+\+LENGTH}~\mbox{\hyperlink{dev___l_c_d_8h_afa3938c4bd2d6c656eedae37d94dc273}{DEV\+\_\+\+LCD\+\_\+\+COLS}} + 1    /\texorpdfstring{$\ast$}{*} 16 Caracteres del LCD + \textbackslash{}0 \texorpdfstring{$\ast$}{*}/
\item 
\Hypertarget{fw_2app_2mcu_2src_2sys_2sys__sm_8c_ab0aa36e1bdc251eaaada3e409312d8ae}\label{fw_2app_2mcu_2src_2sys_2sys__sm_8c_ab0aa36e1bdc251eaaada3e409312d8ae} 
\#define {\bfseries BOOT\+\_\+\+MAX\+\_\+\+TRIES}~3                            /\texorpdfstring{$\ast$}{*} Numero de intentos de inicialización por periférico \texorpdfstring{$\ast$}{*}/
\item 
\Hypertarget{fw_2app_2mcu_2src_2sys_2sys__sm_8c_a1df5568e6774b73aa4c6e59fc40e9147}\label{fw_2app_2mcu_2src_2sys_2sys__sm_8c_a1df5568e6774b73aa4c6e59fc40e9147} 
\#define {\bfseries RTC\+\_\+\+YEAR}~25
\item 
\Hypertarget{fw_2app_2mcu_2src_2sys_2sys__sm_8c_abda0c877ee1a02b8351c0cfe72838088}\label{fw_2app_2mcu_2src_2sys_2sys__sm_8c_abda0c877ee1a02b8351c0cfe72838088} 
\#define {\bfseries RTC\+\_\+\+MONTH}~10
\item 
\Hypertarget{fw_2app_2mcu_2src_2sys_2sys__sm_8c_a6f25f228247dc102195a2adf70311dc5}\label{fw_2app_2mcu_2src_2sys_2sys__sm_8c_a6f25f228247dc102195a2adf70311dc5} 
\#define {\bfseries RTC\+\_\+\+DATE}~15
\item 
\Hypertarget{fw_2app_2mcu_2src_2sys_2sys__sm_8c_a8645ae13bb42ddf10d3ca762a8754160}\label{fw_2app_2mcu_2src_2sys_2sys__sm_8c_a8645ae13bb42ddf10d3ca762a8754160} 
\#define {\bfseries RTC\+\_\+\+DAY}~3
\item 
\Hypertarget{fw_2app_2mcu_2src_2sys_2sys__sm_8c_a7264eac87ffc91cbdea1239d346a0ea4}\label{fw_2app_2mcu_2src_2sys_2sys__sm_8c_a7264eac87ffc91cbdea1239d346a0ea4} 
\#define {\bfseries RTC\+\_\+\+HOUR}~14
\item 
\Hypertarget{fw_2app_2mcu_2src_2sys_2sys__sm_8c_a34fc4e7c0e5db231217aa3174e394c72}\label{fw_2app_2mcu_2src_2sys_2sys__sm_8c_a34fc4e7c0e5db231217aa3174e394c72} 
\#define {\bfseries RTC\+\_\+\+MIN}~30
\item 
\Hypertarget{fw_2app_2mcu_2src_2sys_2sys__sm_8c_a2507e650d4ccc8a2bdf3001800a3e743}\label{fw_2app_2mcu_2src_2sys_2sys__sm_8c_a2507e650d4ccc8a2bdf3001800a3e743} 
\#define {\bfseries RTC\+\_\+\+SEC}~0
\end{DoxyCompactItemize}
\doxysubsubsection*{Enumeraciones}
\begin{DoxyCompactItemize}
\item 
\Hypertarget{fw_2app_2mcu_2src_2sys_2sys__sm_8c_a9a1771f1c13e930cd386130919f3ce93}\label{fw_2app_2mcu_2src_2sys_2sys__sm_8c_a9a1771f1c13e930cd386130919f3ce93} 
enum \mbox{\hyperlink{fw_2app_2mcu_2src_2sys_2sys__sm_8c_a9a1771f1c13e930cd386130919f3ce93}{Device\+\_\+\+Init\+\_\+\+Stage}} \{ \newline
{\bfseries DEV\+\_\+\+INIT\+\_\+\+LCD} = 0
, {\bfseries DEV\+\_\+\+INIT\+\_\+\+RTC}
, {\bfseries DEV\+\_\+\+INIT\+\_\+\+MPU}
, {\bfseries DEV\+\_\+\+INIT\+\_\+\+COMPLETE}
, \newline
{\bfseries DEV\+\_\+\+INIT\+\_\+\+ERROR}
 \}
\begin{DoxyCompactList}\small\item\em Estado de inicialización de periféricos durante el arranque del sistema. \end{DoxyCompactList}\end{DoxyCompactItemize}
\doxysubsubsection*{Funciones}
\begin{DoxyCompactItemize}
\item 
HAL\+\_\+\+Status\+Type\+Def \mbox{\hyperlink{fw_2app_2mcu_2src_2sys_2sys__sm_8c_a6fcdcaff4e6bfff5e8dc9aa8a033bce6}{SM\+\_\+\+Init\+OS}} (void)
\begin{DoxyCompactList}\small\item\em Crea e inicializa la tarea principal de la máquina de estados, utilizando el Free\+RTOS proporcionado por el Cube\+MX. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{fw_2app_2mcu_2src_2sys_2sys__sm_8c_a221be4011b053587c845d04751aeacc7}{SM\+\_\+\+Iter}} (void \texorpdfstring{$\ast$}{*}argument)
\begin{DoxyCompactList}\small\item\em Máquina de estados principal del sistema. \end{DoxyCompactList}\end{DoxyCompactItemize}


\doxysubsection{Descripción detallada}
Máquina de estados principal del sistema. 

Esta SM se encarga de coordinar todo el flujo del dispositivo\+: arranca los periféricos (LCD, RTC, MPU6050), realiza las lecturas periódicas y muestra la información tanto en pantalla como por UART. Además, controla el parpadeo del LED según el ángulo de inclinación detectado.

Ciclo principal (≈100 ms)\+:
\begin{DoxyEnumerate}
\item Lee los sensores.
\item Calcula el ángulo de inclinación.
\item Ajusta la frecuencia del LED según el ángulo.
\item Actualiza la hora y el ángulo en LCD y UART.
\end{DoxyEnumerate}

Flujo de estados\+: ST\+\_\+\+INIT ↓ ST\+\_\+\+READ\+\_\+\+SENSORS → ST\+\_\+\+UPDATE\+\_\+\+LED → ST\+\_\+\+UPDATE\+\_\+\+UART → (vuelve a leer)

\begin{DoxyAuthor}{Autor}
Matías Durante 
\end{DoxyAuthor}
\begin{DoxyVersion}{Versión}
1.\+0 
\end{DoxyVersion}
\begin{DoxyDate}{Fecha}
2025 
\end{DoxyDate}


\label{doc-define-members}
\Hypertarget{fw_2app_2mcu_2src_2sys_2sys__sm_8c_doc-define-members}
\doxysubsection{Documentación de «define»}
\Hypertarget{fw_2app_2mcu_2src_2sys_2sys__sm_8c_afde0a91566f74d38cdffe80c6635576d}\index{sys\_sm.c@{sys\_sm.c}!SAMPLE\_PERIOD\_MS@{SAMPLE\_PERIOD\_MS}}
\index{SAMPLE\_PERIOD\_MS@{SAMPLE\_PERIOD\_MS}!sys\_sm.c@{sys\_sm.c}}
\doxysubsubsection{\texorpdfstring{SAMPLE\_PERIOD\_MS}{SAMPLE\_PERIOD\_MS}}
{\footnotesize\ttfamily \label{fw_2app_2mcu_2src_2sys_2sys__sm_8c_afde0a91566f74d38cdffe80c6635576d} 
\#define SAMPLE\+\_\+\+PERIOD\+\_\+\+MS~100}



Configuración del ciclo de muestreo y actualización del sistema. 


\begin{DoxyItemize}
\item El loop principal corre cada 100 ms (PERIOD\+\_\+100\+MS).
\item Se lee la información del RTC y se actualizan los valores del LCD cada 1 segundo. 
\end{DoxyItemize}

\label{doc-func-members}
\Hypertarget{fw_2app_2mcu_2src_2sys_2sys__sm_8c_doc-func-members}
\doxysubsection{Documentación de funciones}
\Hypertarget{fw_2app_2mcu_2src_2sys_2sys__sm_8c_a6fcdcaff4e6bfff5e8dc9aa8a033bce6}\index{sys\_sm.c@{sys\_sm.c}!SM\_InitOS@{SM\_InitOS}}
\index{SM\_InitOS@{SM\_InitOS}!sys\_sm.c@{sys\_sm.c}}
\doxysubsubsection{\texorpdfstring{SM\_InitOS()}{SM\_InitOS()}}
{\footnotesize\ttfamily \label{fw_2app_2mcu_2src_2sys_2sys__sm_8c_a6fcdcaff4e6bfff5e8dc9aa8a033bce6} 
HAL\+\_\+\+Status\+Type\+Def SM\+\_\+\+Init\+OS (\begin{DoxyParamCaption}\item[{void}]{}{}\end{DoxyParamCaption})}



Crea e inicializa la tarea principal de la máquina de estados, utilizando el Free\+RTOS proporcionado por el Cube\+MX. 


\begin{DoxyRetVals}{Valores devueltos}
{\em HAL\+\_\+\+OK} & si la tarea fue creada correctamente. \\
\hline
\end{DoxyRetVals}
\Hypertarget{fw_2app_2mcu_2src_2sys_2sys__sm_8c_a221be4011b053587c845d04751aeacc7}\index{sys\_sm.c@{sys\_sm.c}!SM\_Iter@{SM\_Iter}}
\index{SM\_Iter@{SM\_Iter}!sys\_sm.c@{sys\_sm.c}}
\doxysubsubsection{\texorpdfstring{SM\_Iter()}{SM\_Iter()}}
{\footnotesize\ttfamily \label{fw_2app_2mcu_2src_2sys_2sys__sm_8c_a221be4011b053587c845d04751aeacc7} 
void SM\+\_\+\+Iter (\begin{DoxyParamCaption}\item[{void \texorpdfstring{$\ast$}{*}}]{argument}{}\end{DoxyParamCaption})}



Máquina de estados principal del sistema. 

Tarea que ejecuta la máquina de estados.

Estados\+:
\begin{DoxyItemize}
\item ST\+\_\+\+INIT\+: Inicializa periféricos. Si inicializan correctamente, se pasa al estado ST\+\_\+\+READ\+\_\+\+SENSORS; En caso de falla luego de los reintentos, se pasa al estado ST\+\_\+\+ERROR.
\item ST\+\_\+\+READ\+\_\+\+SENSORS\+: Lee la información del MPU6050, filtra el ángulo y pasa a ST\+\_\+\+UPDATE\+\_\+\+LED.
\item ST\+\_\+\+UPDATE\+\_\+\+LED\+: Ajusta el periodo de parpadeo según el ángulo; pasa a ST\+\_\+\+UPDATE\+\_\+\+UART.
\item ST\+\_\+\+UPDATE\+\_\+\+UART\+: Envía hora y ángulo por UART; vuelve a ST\+\_\+\+READ\+\_\+\+SENSORS.
\item ST\+\_\+\+ERROR\+: Muestra un mensaje de error en el LCD y reinicia el MCU.
\item RTC\+: Actualiza el LCD cada 1 s con hora y ángulo.
\item LED\+: Parpadea según la inclinación calculada. 
\end{DoxyItemize}